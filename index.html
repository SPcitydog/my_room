<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebAR - Hiro + Persistent Model + Version Tag</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #versionTag {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        padding: 6px 10px;
        font-family: monospace;
        font-size: 14px;
        z-index: 9999;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <!-- ‚úÖ È†ÇÈÉ®ÁâàÊú¨È°ØÁ§∫ÂçÄ -->
    <div id="versionTag">üõ†Ô∏è Ê∏¨Ë©¶Áâà v1.0.1 - Ê®°ÂûãÂÆö‰ΩçÂæåÊåÅ‰πÖÈ°ØÁ§∫</div>

    <a-scene
      embedded
      arjs="sourceType: webcam;"
      renderer="logarithmicDepthBuffer: true;"
    >
      <!-- Áõ∏Ê©ü -->
      <a-entity camera></a-entity>

      <!-- Hiro marker Áî®ÊñºÂàùÂßãÂÆö‰Ωç -->
      <a-marker preset="hiro" id="hiroMarker" emitevents="true">
        <!-- ÊèêÁ§∫ÊñπÂ°ä -->
        <a-box color="red" position="0 0.1 0" width="0.1" height="0.1" depth="0.1"></a-box>
        <!-- Êö´ÊôÇËºâÂÖ•Ê®°ÂûãÁöÑÂÆπÂô® -->
        <a-entity id="tempModel"></a-entity>
      </a-marker>

      <!-- Ê®°ÂûãÂÆö‰ΩçÊàêÂäüÂæåÁßªËá≥Ê≠§ËôïÔºåÁ¢∫‰øù marker Ê∂àÂ§±Âæå‰ªçÊåÅÁ∫åÈ°ØÁ§∫ -->
      <a-entity id="persistedModels"></a-entity>
    </a-scene>

    <script>
      const marker = document.getElementById("hiroMarker");
      const tempModel = document.getElementById("tempModel");
      const persistedModels = document.getElementById("persistedModels");

      let modelSpawned = false;

      marker.addEventListener("markerFound", () => {
        if (modelSpawned) return;
        modelSpawned = true;

        // ËºâÂÖ•Ê®°ÂûãÔºàÂèØÊîπÊàê‰Ω†ÁöÑÊ®°ÂûãË∑ØÂæëÔºâ
        const el = document.createElement("a-entity");
        el.setAttribute("gltf-model", "url(assets/axe.glb)");
        el.setAttribute("scale", "0.2 0.2 0.2");
        el.object3D.position.set(0, 0, 0);
        tempModel.appendChild(el);

        el.addEventListener("model-loaded", () => {
          const clone = document.createElement("a-entity");

          const pos = new THREE.Vector3();
          const rot = new THREE.Quaternion();
          const scale = new THREE.Vector3();
          el.object3D.updateMatrixWorld(true);
          el.object3D.matrixWorld.decompose(pos, rot, scale);

          const euler = new THREE.Euler().setFromQuaternion(rot, 'XYZ');

          clone.setAttribute("gltf-model", "url(assets/axe.glb)");
          clone.setAttribute("position", `${pos.x} ${pos.y} ${pos.z}`);
          clone.setAttribute("rotation", `${THREE.Math.radToDeg(euler.x)} ${THREE.Math.radToDeg(euler.y)} ${THREE.Math.radToDeg(euler.z)}`);
          clone.setAttribute("scale", `${scale.x} ${scale.y} ${scale.z}`);
          clone.setAttribute("animation-mixer", "");

          persistedModels.appendChild(clone);
        });
      });
    </script>
  </body>
</html>
